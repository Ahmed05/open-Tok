<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
			
    <script src="http://localhost/socket.io/socket.io.js"></script>

	 <script src='http://static.opentok.com/webrtc/v2.2/js/TB.min.js'></script>
<body>
	<div id="links">
		
         <input type="button" value="Connect" id ="connectLink" onClick="javascript:connect()" />
         <input type="button" value="Disconnect" id ="disconnectLink" onClick="javascript:disconnect()" style="display:none" />
         <input type="button" value="Publish" id ="publishLink" onClick="javascript:startPublishing()" style="display:none" />
         <input type="button" value="Unpublish" id ="unpublishLink" onClick="javascript:stopPublishing()" style="display:none" />  
		 <input type="button" value="Archive" id ="archiveLink" onClick="javascript:startArchive()" style="display:none" />  		 
        
  </div>
    <div id="publisherContainer"></div>
  <div id="subscribersContainer"></div>
	
</body>
	<title>OpenTok Node.js</title>
	
<script>  
  var API_KEY = '45502132';
  var token;
  var sessionId;
  

   
	  var socket = io.connect('http://localhost'); // connec to server
	  socket.on('session', function (data) { // listen to session event raised by the server
		//alert(data.sessionId);
		sessionId = data.sessionId;
		
		socket.emit('session id', { my: 'data' }); // raise an event on the server
	  });
	
 
  

   
	 
	  socket.on('token', function (data) { // listen to token event raised by the server
		//alert(data.Token);
		token = data.Token;
		
		socket.emit('token id', { my: 'data' }); // raise an event on the server
	  });
	  
	  
	  
	
//Creating session here

var session;
var connectionCount = 0;

function connect() {
  // Replace apiKey and sessionId with your own values:
  
  session = OT.initSession(API_KEY, sessionId);
  session.on({
    connectionCreated: function (event) {
      connectionCount++;
      console.log(connectionCount + ' connections.');
    },
    connectionDestroyed: function (event) {
      connectionCount--;
      console.log(connectionCount + ' connections.');
    },
    sessionDisconnected: function sessionDisconnectHandler(event) {
      // The event is defined by the SessionDisconnectEvent class
      console.log('Disconnected from the session.');
      document.getElementById('disconnectLink').style.display = 'none';
	  document.getElementById('publishLink').style.display = 'none';
      if (event.reason == 'networkDisconnected') {
        alert('Your network connection terminated.')
      }
    }
  });
  // Replace token with your own value:
  
  session.connect(token, function(error) {
    if (error) {
      console.log('Unable to connect: ', error.message);
    } else {
       document.getElementById('disconnectLink').style.display = 'block';
	   document.getElementById('publishLink').style.display = 'block';
      console.log('Connected to the session.');
      connectionCount = 1;
    }
  });
}

function disconnect() {
  session.disconnect();
}
var publisher;
function startPublishing()
{
	alert("api and sessionid"+API_KEY+"=="+sessionId);
	var publisherOptions = {
      name: 'A web-based OpenTok client',
      insertMode: 'append'
    };
	 publisher = OT.initPublisher('publisherContainer', publisherOptions);
    session.publish(publisher, function(error) {
      if (error) {
        alert("error:"+error.message);
      }	 	  
    });	
	
	document.getElementById('unpublishLink').style.display = 'block';
	document.getElementById('archiveLink').style.display = 'block';	 
	
}

function stopPublishing()
{
	 session.unpublish(publisher);
	 document.getElementById('unpublishLink').style.display = 'none';
	 document.getElementById('archiveLink').style.display = 'none';
	 
}

function startArchive()
{
	
	socket.on('archive', function (data) { // listen to token event raised by the server
		alert(data.Archive);
		archive = data.Archive;
		
		socket.emit('token id', { my: 'data' }); // raise an event on the server
	  });
}


			
</script>
</head>


</html>
